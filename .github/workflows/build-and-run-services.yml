name: cicd pipeline

on:
  workflow_dispatch:
  #push:
   # branches: ["main"]

jobs:
  docker_build:
    runs-on: ubuntu-latest


    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build all services
        run: | 
          for dir in src/*/ ; do 
            service=$(basename "$dir") 
            echo "ðŸš€ Building $service..." 
            if [ "$service" = "cartservice" ]; 
            then 
              context="$dir/src" 
            else 
              context="$dir" 
            fi 
            docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/$service:latest "$context" 
            docker push ${{ secrets.DOCKERHUB_USERNAME }}/$service:latest
          done
